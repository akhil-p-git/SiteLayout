// MVP+ Site Layouts - Database Schema
// PostgreSQL with PostGIS extension for geospatial data

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  // extensions = [postgis] // Temporarily disabled for local dev without PostGIS
}

// =============================================================================
// ENUMS
// =============================================================================

enum ProjectStatus {
  active
  archived
  completed
}

enum SiteStatus {
  draft
  analyzed
  optimized
  finalized
}

enum LayoutStatus {
  draft
  optimized
  approved
  rejected
}

enum ExclusionZoneType {
  wetland
  setback
  easement
  environmental
  custom
}

enum AssetType {
  bess_container
  bess_array
  substation
  om_building
  parking
  laydown
  transformer
  inverter
  solar_array
  custom
}

enum RoadType {
  access
  internal
  emergency
}

enum EntryPointType {
  primary
  secondary
  emergency
  maintenance
  construction
}

enum OptimizationObjective {
  min_earthwork
  max_capacity
  balanced
}

enum UserRole {
  admin
  manager
  analyst
  viewer
}

enum JobType {
  terrain_analysis
  optimization
  export
}

enum JobStatus {
  queued
  processing
  completed
  failed
}

// =============================================================================
// CORE ENTITIES
// =============================================================================

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(100)
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  projects Project[]
  users    User[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  email          String   @unique @db.VarChar(255)
  name           String   @db.VarChar(255)
  role           UserRole @default(viewer)
  externalId     String?  @unique @map("external_id") @db.VarChar(255)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]
  layouts      Layout[]
  auditLogs    AuditLog[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Project {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  name           String        @db.VarChar(255)
  description    String?       @db.Text
  status         ProjectStatus @default(active)
  metadata       Json          @default("{}")
  createdById    String        @map("created_by") @db.Uuid
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdById], references: [id])
  sites        Site[]

  @@index([organizationId])
  @@index([status])
  @@map("projects")
}

// =============================================================================
// SITE & TERRAIN
// =============================================================================

model Site {
  id            String     @id @default(uuid()) @db.Uuid
  projectId     String     @map("project_id") @db.Uuid
  name          String     @db.VarChar(255)
  description   String?    @db.Text
  locationLat   Float?     @map("location_lat")
  locationLng   Float?     @map("location_lng")
  address       String?    @db.Text
  region        String?    @db.VarChar(100)
  boundaryArea  Float?     @map("boundary_area")
  demUrl        String?    @map("dem_url") @db.Text
  demResolution Float?     @map("dem_resolution")
  minElevation  Float?     @map("min_elevation")
  maxElevation  Float?     @map("max_elevation")
  avgSlope      Float?     @map("avg_slope")
  status        SiteStatus @default(draft)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Note: boundary and entry_points are PostGIS geometry columns
  // Added via raw SQL migration

  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  exclusionZones ExclusionZone[]
  entryPoints    EntryPoint[]
  layouts        Layout[]

  @@index([projectId])
  @@index([status])
  @@map("sites")
}

model ExclusionZone {
  id        String            @id @default(uuid()) @db.Uuid
  siteId    String            @map("site_id") @db.Uuid
  name      String            @db.VarChar(255)
  type      ExclusionZoneType
  buffer    Float             @default(0)
  notes     String?           @db.Text
  createdAt DateTime          @default(now()) @map("created_at")

  // Note: geometry is a PostGIS geometry column
  // Added via raw SQL migration

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@map("exclusion_zones")
}

model EntryPoint {
  id           String         @id @default(uuid()) @db.Uuid
  siteId       String         @map("site_id") @db.Uuid
  name         String         @db.VarChar(255)
  type         EntryPointType @default(primary)
  capacity     Int?
  restrictions Json?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Note: geometry is a PostGIS POINT geometry column (SRID 4326)
  // Added via raw SQL migration

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([type])
  @@map("entry_points")
}

// =============================================================================
// LAYOUT & ASSETS
// =============================================================================

model Layout {
  id            String       @id @default(uuid()) @db.Uuid
  siteId        String       @map("site_id") @db.Uuid
  version       Int
  name          String       @db.VarChar(255)
  status        LayoutStatus @default(draft)
  configuration Json
  metrics       Json         @default("{}")
  createdById   String       @map("created_by") @db.Uuid
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  site            Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdBy       User              @relation(fields: [createdById], references: [id])
  assetPlacements AssetPlacement[]
  roadSegments    RoadSegment[]
  earthworkSummary EarthworkSummary?

  @@unique([siteId, version])
  @@index([siteId])
  @@index([status])
  @@map("layouts")
}

model AssetPlacement {
  id                     String    @id @default(uuid()) @db.Uuid
  layoutId               String    @map("layout_id") @db.Uuid
  assetType              AssetType @map("asset_type")
  name                   String    @db.VarChar(255)
  dimensions             Json?
  elevation              Json?
  earthwork              Json?
  constraints            Json?
  constraintViolations   Json?     @map("constraint_violations")
  metadata               Json      @default("{}")
  createdAt              DateTime  @default(now()) @map("created_at")

  // Note: geometry and centroid are PostGIS geometry columns
  // Added via raw SQL migration

  layout Layout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@index([assetType])
  @@map("asset_placements")
}

model RoadSegment {
  id                String   @id @default(uuid()) @db.Uuid
  layoutId          String   @map("layout_id") @db.Uuid
  length            Float?
  width             Float?
  grade             Float[]  @default([])
  maxGrade          Float?   @map("max_grade")
  avgGrade          Float?   @map("avg_grade")
  elevationProfile  Json?    @map("elevation_profile")
  earthwork         Json?
  type              RoadType @default(access)
  createdAt         DateTime @default(now()) @map("created_at")

  // Note: geometry is a PostGIS geometry column
  // Added via raw SQL migration

  layout Layout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@map("road_segments")
}

// =============================================================================
// EARTHWORK & CALCULATIONS
// =============================================================================

model EarthworkSummary {
  id           String   @id @default(uuid()) @db.Uuid
  layoutId     String   @unique @map("layout_id") @db.Uuid
  components   Json
  totals       Json
  costs        Json
  calculatedAt DateTime @default(now()) @map("calculated_at")

  layout Layout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@map("earthwork_summaries")
}

// =============================================================================
// JOBS & ASYNC PROCESSING
// =============================================================================

model Job {
  id          String    @id @default(uuid()) @db.Uuid
  type        JobType
  status      JobStatus @default(queued)
  progress    Int       @default(0)
  input       Json?
  result      Json?
  error       String?   @db.Text
  entityType  String?   @map("entity_type") @db.VarChar(100)
  entityId    String?   @map("entity_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@index([type, status])
  @@index([entityType, entityId])
  @@map("jobs")
}

// =============================================================================
// AUDIT & LOGGING
// =============================================================================

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(100)
  entityId   String?  @map("entity_id") @db.Uuid
  changes    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_log")
}
